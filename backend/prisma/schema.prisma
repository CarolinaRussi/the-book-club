generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Book {
  id              String       @id @default(cuid())
  title           String       @db.VarChar(255)
  author          String?      @db.VarChar(255)
  cover_url       String?      @db.VarChar(255)
  open_library_id String?      @db.VarChar(255)
  created_at      DateTime     @default(now()) @db.Timestamp(6)
  cover_public_id String?      @db.VarChar(255)
  
  meeting         Meeting[]
  clubs           ClubBook[]
  users_books     UserBook[]
  reviews         Review[]
}

model Club {
  id              String      @id @default(cuid())
  name            String      @db.VarChar(255)
  invitation_code String      @unique @db.VarChar(255)
  owner_id        String
  status          StatusEnum @default(active)
  created_at      DateTime    @default(now()) @db.Timestamp(6)
  description     String
  
  user            User        @relation(fields: [owner_id], references: [id], onDelete: Restrict, onUpdate: NoAction)
  meeting         Meeting[]
  member          Member[]
  books           ClubBook[]
}

model Meeting {
  id           String   @id @default(cuid())
  club_id      String
  location     String   @db.VarChar(255)
  meeting_date DateTime @db.Date
  meeting_time DateTime @db.Time(0)
  description  String?  @db.Text
  status       MeetingStatusEnum @default(scheduled)
  book_id      String
  created_at   DateTime @default(now()) @db.Timestamp(6)
  book       Book     @relation(fields: [book_id], references: [id], onDelete: Restrict, onUpdate: NoAction)
  club       Club     @relation(fields: [club_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  confirmations MeetingConfirmation[]
}

model Member {
  id        String  @id @default(cuid())
  user_id   String
  club_id   String
  joined_at DateTime @default(now()) @db.Timestamp(6)

  club     Club    @relation(fields: [club_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user     User    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  confirmations MeetingConfirmation[]
}

model Review {
  id             String  @id @default(cuid())
  user_id        String
  book_id        String
  rating         Int?
  comment        String? @db.Text
  created_at     DateTime            @default(now()) @db.Timestamp(6)

  book           Book               @relation(fields: [book_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user           User             @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model User {
  id                        String  @id @default(cuid())
  name                      String      @db.VarChar(255)
  email                     String      @unique @db.VarChar(255)
  password                  String      @db.VarChar(255)
  profile_picture           String?     @db.VarChar(255)
  favorites_genres          String[]    
  bio                       String?
  status                    StatusEnum @default(active)
  created_at                DateTime    @default(now()) @db.Timestamp(6)
  nickname                  String      @db.VarChar(255)
  profile_picture_public_id String?     @db.VarChar(255)
  club                      Club[]
  member                    Member[]
  user_books                UserBook[]
  reviews                   Review[]
}

model UserBook {
  id             String            @id @default(cuid())
  user_id        String
  book_id        String
  reading_status ReadingStatusEnum @default(want_to_read)
  created_at     DateTime          @default(now())
  updated_at     DateTime          @updatedAt

  user        User              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  book        Book              @relation(fields: [book_id], references: [id], onDelete: Cascade)

  @@unique([user_id, book_id])
}

model ClubBook {
  id        String           @id @default(cuid())
  club_id   String
  book_id   String
  status    BookStatusEnum   @default(suggested)
  added_at  DateTime         @default(now())

  club      Club             @relation(fields: [club_id], references: [id], onDelete: Cascade)
  book      Book             @relation(fields: [book_id], references: [id], onDelete: Cascade)
  
  @@unique([club_id, book_id]) 
}

model MeetingConfirmation {
  id         String   @id @default(cuid())
  meeting_id String
  member_id    String
  status     ConfirmationStatusEnum
  created_at DateTime @default(now())

  meeting   Meeting   @relation(fields: [meeting_id], references: [id], onDelete: Cascade)
  member    Member    @relation(fields: [member_id], references: [id], onDelete: Cascade)

  @@unique([meeting_id, member_id])
}

enum ReadingStatusEnum {
  want_to_read
  not_started
  dropped
  started
  finished
}

enum StatusEnum {
  active
  inactive
}

enum BookStatusEnum {
  suggested
  started
  dropped
  finished
}

enum MeetingStatusEnum {
  scheduled
  completed
  cancelled
}

enum ConfirmationStatusEnum {
  going
  not_going
  maybe
}